<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>estebang23.github.io</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="estebang23.github.io" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/node_modules/node-sass/src/libsass/docs/source-map-internals.html" />
<meta property="og:url" content="http://localhost:4000/node_modules/node-sass/src/libsass/docs/source-map-internals.html" />
<meta property="og:site_name" content="estebang23.github.io" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/node_modules/node-sass/src/libsass/docs/source-map-internals.html","headline":"estebang23.github.io","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=08194154e5c3f87742365edb210c0599bab19902">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">estebang23.github.io</a></h1>
      

      <p>This document is mainly intended for developers!</p>

<h1 id="documenting-some-of-the-source-map-internals">Documenting some of the source map internals</h1>

<p>Since source maps are somewhat a black box to all LibSass maintainers, <a href="@mgreter">I</a> will try to document my findings with source maps in LibSass, as I come across them. This document will also brievely explain how LibSass parses the source and how it outputs the result.</p>

<p>The main storage for SourceMap mappings is the <code class="highlighter-rouge">mappings</code> vector:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># in source_map.hpp
vector&lt;Mapping&gt; mappings
# in mappings.hpp
struct Mapping ...
  Position original_position;
  Position generated_position;
</code></pre></div></div>

<h2 id="every-parsed-token-has-its-source-associated">Every parsed token has its source associated</h2>

<p>LibSass uses a lexical parser. Whenever LibSass finds a token of interest, it creates a specific <code class="highlighter-rouge">AST_Node</code>, which will hold a reference to the input source with line/column information. <code class="highlighter-rouge">AST_Node</code> is the base class for all parsed items. They are declared in <code class="highlighter-rouge">ast.hpp</code> and are used in <code class="highlighter-rouge">parser.hpp</code>. Here a simple example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (lex&lt; custom_property_name &gt;()) {
  Sass::String* prop = new (ctx.mem) String_Constant(path, source_position, lexed);
  return new (ctx.mem) Declaration(path, prop-&gt;position(), prop, ...);
}
</code></pre></div></div>

<h2 id="how-is-the-source_position-calculated">How is the <code class="highlighter-rouge">source_position</code> calculated</h2>

<p>This is automatically done with <code class="highlighter-rouge">lex</code> in <code class="highlighter-rouge">parser.hpp</code>. Whenever something is lexed, the <code class="highlighter-rouge">source_position</code> is updated. But be aware that <code class="highlighter-rouge">source_position</code> points to the begining of the parsed text. If you need a mapping for the position where the parsing ended, you need to add another call to <code class="highlighter-rouge">lex</code> (to match nothing)!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lex&lt; exactly &lt; empty_str &gt; &gt;();
end = new (ctx.mem) String_Constant(path, source_position, lexed);
</code></pre></div></div>

<h2 id="how-are-mappings-for-the-output-created">How are mappings for the output created</h2>

<p>So far we have collected all needed data for all tokens in the input stream. We can now use this information to create mappings when we put things into the output stream. Mappings are created via the <code class="highlighter-rouge">add_mappings</code> method:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># in source_map.hpp
void add_mapping(AST_Node* node);
</code></pre></div></div>

<p>This method is called in two places:</p>
<ul>
  <li><code class="highlighter-rouge">Inspect::append_to_buffer</code></li>
  <li><code class="highlighter-rouge">Output_[Nested|Compressed]::append_to_buffer</code></li>
</ul>

<p>Mappings can only be created for things that have been parsed into a <code class="highlighter-rouge">AST_Node</code>. Otherwise we do not have the information to create the mappings, which is the reason why LibSass currently only maps the most important tokens in source maps.</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
